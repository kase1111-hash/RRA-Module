# Story Protocol Scripts Validation Workflow
# Validates JavaScript scripts for Story Protocol integration

name: Scripts Validation

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/scripts.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/scripts.yml'
  workflow_dispatch:

jobs:
  # ===========================================================================
  # Validate Scripts
  # ===========================================================================
  validate:
    name: Validate Scripts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scripts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Validate configuration module
        run: |
          node -e "
            const config = require('./config');

            // Validate exports
            const required = ['network', 'rpcUrl', 'chainId', 'contracts', 'getPrivateKey', 'validate', 'printSummary'];
            const missing = required.filter(key => !(key in config));

            if (missing.length > 0) {
              console.error('Missing exports:', missing);
              process.exit(1);
            }

            // Validate contract addresses
            const contracts = ['licensingModule', 'pilTemplate', 'royaltyModule', 'ipAssetRegistry', 'wipToken'];
            for (const c of contracts) {
              if (!config.contracts[c] || !config.contracts[c].startsWith('0x')) {
                console.error('Invalid contract address:', c);
                process.exit(1);
              }
            }

            console.log('Configuration module validated successfully');
            console.log('  Network:', config.network);
            console.log('  Chain ID:', config.chainId);
            console.log('  Contracts:', Object.keys(config.contracts).length);
          "

      - name: Check script syntax
        run: |
          echo "Checking JavaScript syntax..."
          for script in *.js; do
            echo "  Checking $script..."
            node --check "$script" || exit 1
          done
          echo "All scripts have valid syntax"

      - name: Validate ABI definitions
        run: |
          node -e "
            const fs = require('fs');

            // Find all ABI definitions in scripts
            const scripts = fs.readdirSync('.').filter(f => f.endsWith('.js'));
            let abiCount = 0;

            for (const script of scripts) {
              const content = fs.readFileSync(script, 'utf8');
              const abiMatches = content.match(/const \w+ABI = \[/g) || [];
              abiCount += abiMatches.length;
            }

            console.log('Found', abiCount, 'ABI definitions across', scripts.length, 'scripts');
          "

  # ===========================================================================
  # Test Scripts (Dry Run)
  # ===========================================================================
  dry-run:
    name: Dry Run Tests
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: scripts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Test config loading
        run: |
          # Test that config loads without errors
          node -e "
            const config = require('./config');
            config.printSummary();
          "

      - name: Generate script documentation
        run: |
          echo "## Story Protocol Scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Script | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Extract purpose from each script's header comment
          for script in *.js; do
            PURPOSE=$(head -10 "$script" | grep -E "^\s*\*\s+\w" | head -1 | sed 's/.*\* //' || echo "Script")
            echo "| \`$script\` | $PURPOSE |" >> $GITHUB_STEP_SUMMARY
          done

  # ===========================================================================
  # Security Check
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scripts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."

          # Check for private key patterns (excluding test/example patterns)
          if grep -rE "0x[a-fA-F0-9]{64}" *.js | grep -v "example\|test\|sample\|0x0{64}"; then
            echo "WARNING: Potential private key found"
            exit 1
          fi

          # Check for API key patterns
          if grep -rE "(api[_-]?key|apikey)\s*[:=]\s*['\"][^'\"]+['\"]" *.js --ignore-case | grep -v "process.env"; then
            echo "WARNING: Potential hardcoded API key found"
            exit 1
          fi

          echo "No hardcoded secrets detected"
