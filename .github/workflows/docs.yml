# Documentation Generation & Validation Workflow
# Validates documentation, generates API docs, and optionally publishes

name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.py'
      - 'scripts/**/*.js'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.py'
      - 'scripts/**/*.js'
      - 'README.md'
  workflow_dispatch:

jobs:
  # ===========================================================================
  # Validate Documentation
  # ===========================================================================
  validate:
    name: Validate Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true

      - name: Lint markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            docs/**/*.md
            README.md
        continue-on-error: true

      - name: Check for required documentation
        run: |
          echo "## Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Required documentation files
          REQUIRED_DOCS=(
            "README.md"
            "docs/README.md"
            "docs/USAGE-GUIDE.md"
            "docs/STORY-PROTOCOL-INTEGRATION.md"
            "docs/SELLING-LICENSES.md"
          )

          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "- [x] $doc" >> $GITHUB_STEP_SUMMARY
            else
              echo "- [ ] $doc (MISSING)" >> $GITHUB_STEP_SUMMARY
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "**Warning:** $MISSING required documentation file(s) missing" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Generate API Documentation
  # ===========================================================================
  generate-api-docs:
    name: Generate API Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pdoc3 pydoc-markdown sphinx
          pip install -e . || pip install -r requirements.txt || true

      - name: Generate Python API docs
        run: |
          mkdir -p docs/api

          # Generate module documentation
          if [ -d "src" ]; then
            pdoc --html --output-dir docs/api src/ || echo "pdoc generation skipped"
          fi

          # Generate docstring summary
          echo "## API Documentation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count documented functions/classes
          DOCUMENTED=$(grep -r '"""' src/ 2>/dev/null | wc -l || echo "0")
          echo "- Documented items: ~$((DOCUMENTED / 2))" >> $GITHUB_STEP_SUMMARY

      - name: Upload API docs
        uses: actions/upload-artifact@v4
        with:
          name: api-docs
          path: docs/api
          retention-days: 30
        if: always()

  # ===========================================================================
  # Generate Script Documentation
  # ===========================================================================
  generate-script-docs:
    name: Generate Script Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Document JavaScript scripts
        run: |
          echo "## Scripts Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Script | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|" >> $GITHUB_STEP_SUMMARY

          # Extract descriptions from script headers
          for script in scripts/*.js; do
            if [ -f "$script" ]; then
              NAME=$(basename "$script")
              # Extract first line of JSDoc comment
              DESC=$(head -20 "$script" | grep -A1 "^\s*\*" | grep -v "^\s*\*\s*$" | head -1 | sed 's/.*\* //' | sed 's/\*\///' || echo "No description")
              echo "| $NAME | $DESC |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Validate script configurations
        run: |
          cd scripts

          # Check if config.js exports expected values
          node -e "
            const config = require('./config');
            console.log('Configuration validated:');
            console.log('  Network:', config.network);
            console.log('  Chain ID:', config.chainId);
            console.log('  Contracts loaded:', Object.keys(config.contracts).length);
          "

  # ===========================================================================
  # Check Documentation Coverage
  # ===========================================================================
  coverage:
    name: Doc Coverage
    runs-on: ubuntu-latest
    needs: [validate, generate-api-docs]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate documentation coverage
        run: |
          echo "## Documentation Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count Python files vs documented files
          PY_FILES=$(find src -name "*.py" 2>/dev/null | wc -l || echo "0")
          DOCSTRINGS=$(grep -rl '"""' src/ 2>/dev/null | wc -l || echo "0")

          if [ "$PY_FILES" -gt 0 ]; then
            COVERAGE=$((DOCSTRINGS * 100 / PY_FILES))
            echo "### Python Documentation" >> $GITHUB_STEP_SUMMARY
            echo "- Files with docstrings: $DOCSTRINGS / $PY_FILES ($COVERAGE%)" >> $GITHUB_STEP_SUMMARY
          fi

          # Count JS files
          JS_FILES=$(find scripts -name "*.js" 2>/dev/null | wc -l || echo "0")
          JS_DOCS=$(grep -rl '/\*\*' scripts/ 2>/dev/null | wc -l || echo "0")

          if [ "$JS_FILES" -gt 0 ]; then
            JS_COV=$((JS_DOCS * 100 / JS_FILES))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### JavaScript Documentation" >> $GITHUB_STEP_SUMMARY
            echo "- Files with JSDoc: $JS_DOCS / $JS_FILES ($JS_COV%)" >> $GITHUB_STEP_SUMMARY
          fi

          # Markdown documentation stats
          MD_FILES=$(find docs -name "*.md" 2>/dev/null | wc -l || echo "0")
          MD_LINES=$(cat docs/*.md docs/**/*.md 2>/dev/null | wc -l || echo "0")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Markdown Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation files: $MD_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Total lines: $MD_LINES" >> $GITHUB_STEP_SUMMARY
