<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase License - RRA-Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-16 max-w-2xl">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Purchase License</h1>
                <p class="text-gray-400">Powered by Story Protocol</p>
            </div>

            <!-- License Details -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">License Details</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Price</span>
                        <span class="font-mono text-green-400">0.005 IP</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Type</span>
                        <span>Perpetual</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Transferable</span>
                        <span>Yes</span>
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Included Features</h2>
                <ul class="space-y-2">
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Automated License Minting</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>On-Chain Revenue Distribution</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Story Protocol Integration</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Smart Contract Infrastructure</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>DeFi Features (Yield, Lending, Fractional IP)</li>
                </ul>
            </div>

            <!-- Wallet Connection -->
            <div id="wallet-section" class="mb-6">
                <button
                    id="connect-btn"
                    onclick="connectWallet()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Connect Wallet
                </button>
            </div>

            <!-- Purchase Button (hidden until wallet connected) -->
            <div id="purchase-section" class="hidden">
                <div class="bg-gray-700/50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Connected:</span>
                        <span id="wallet-address" class="font-mono text-sm"></span>
                    </div>
                </div>
                <button
                    id="purchase-btn"
                    onclick="purchaseLicense()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Purchase License for 0.005 IP
                </button>
            </div>

            <!-- Status Messages -->
            <div id="status" class="mt-6 text-center hidden">
                <div id="status-loading" class="hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                    <p class="text-gray-400">Processing transaction...</p>
                </div>
                <div id="status-success" class="hidden text-green-400">
                    <p class="text-xl mb-2">License Purchased!</p>
                    <a id="tx-link" href="#" target="_blank" class="text-blue-400 hover:underline">View on Explorer</a>
                </div>
                <div id="status-error" class="hidden text-red-400">
                    <p id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Story Protocol Info -->
        <div class="text-center mt-8 text-gray-500">
            <p>License NFT minted on <a href="https://story.foundation" target="_blank" class="text-blue-400 hover:underline">Story Protocol</a></p>
            <p class="text-sm mt-2">
                <a href="https://explorer.story.foundation/ipa/0xf08574c30337dde7C38869b8d399BA07ab23a07F" target="_blank" class="hover:underline">
                    View IP Asset on Story Explorer
                </a>
            </p>
        </div>
    </div>

    <script>
        // All lowercase addresses bypass checksum validation in ethers.js
        const IP_ASSET_ID = "0xf08574c30337dde7c38869b8d399ba07ab23a07f";
        const LICENSE_TERMS_ID = 28438;
        const PRICE_WEI = "5000000000000000"; // 0.005 IP
        const STORY_CHAIN_ID = 1514;
        const STORY_RPC = "https://mainnet.storyrpc.io";

        // Story Protocol Licensing Module Address (lowercase to bypass checksum)
        const LICENSING_MODULE = "0x04fbd8a2e56dd85cfd5500a4a4dfa955b9f1de6f";
        const PIL_TEMPLATE = "0x2e896b0b2fdb7457499b56aaaa4ae55bcb4cd316";
        const WIP_TOKEN = "0x1514000000000000000000000000000000000000";
        const ROYALTY_POLICY_LAP = "0xbe54fb168b3c982b7aae60db6cf75bd8447b390e";

        // WIP Token ABI (for wrapping and approval)
        const WIP_ABI = [
            {
                "inputs": [],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "owner", "type": "address"}, {"name": "spender", "type": "address"}],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let provider;
        let signer;

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet');
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);

                // Check if on Story Protocol network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== STORY_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + STORY_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        // Chain not added, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + STORY_CHAIN_ID.toString(16),
                                    chainName: 'Story Protocol',
                                    nativeCurrency: { name: 'IP', symbol: 'IP', decimals: 18 },
                                    rpcUrls: [STORY_RPC],
                                    blockExplorerUrls: ['https://storyscan.io'],
                                }],
                            });
                        }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                const address = await signer.getAddress();

                document.getElementById('wallet-address').textContent =
                    address.slice(0, 6) + '...' + address.slice(-4);
                document.getElementById('wallet-section').classList.add('hidden');
                document.getElementById('purchase-section').classList.remove('hidden');
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function purchaseLicense() {
            if (!signer) {
                alert('Please connect your wallet first');
                return;
            }

            const statusDiv = document.getElementById('status');
            const loadingDiv = document.getElementById('status-loading');
            const successDiv = document.getElementById('status-success');
            const errorDiv = document.getElementById('status-error');
            const loadingText = document.querySelector('#status-loading p');

            statusDiv.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                const receiverAddress = await signer.getAddress();
                const mintingFee = ethers.parseEther("0.005");
                const approvalAmount = ethers.parseEther("1"); // Approve 1 IP for buffer

                // Create WIP contract instance
                const wipToken = new ethers.Contract(WIP_TOKEN, WIP_ABI, signer);

                // Step 1: Check WIP balance and wrap if needed
                loadingText.textContent = 'Checking WIP balance...';
                const wipBalance = await wipToken.balanceOf(receiverAddress);
                console.log('WIP Balance:', ethers.formatEther(wipBalance));

                if (wipBalance < mintingFee) {
                    loadingText.textContent = 'Wrapping IP to WIP...';
                    const wrapAmount = mintingFee - wipBalance + ethers.parseEther("0.001"); // Small buffer
                    const wrapTx = await wipToken.deposit({ value: wrapAmount });
                    console.log('Wrap TX:', wrapTx.hash);
                    await wrapTx.wait();
                    console.log('IP wrapped to WIP');
                }

                // Step 2: Check and set approvals for LicensingModule
                loadingText.textContent = 'Checking approvals...';
                const licensingAllowance = await wipToken.allowance(receiverAddress, LICENSING_MODULE);
                if (licensingAllowance < approvalAmount) {
                    loadingText.textContent = 'Approving LicensingModule...';
                    const approveTx1 = await wipToken.approve(LICENSING_MODULE, approvalAmount);
                    console.log('Approve LicensingModule TX:', approveTx1.hash);
                    await approveTx1.wait();
                }

                // Step 3: Approve RoyaltyPolicyLAP (required for minting)
                const royaltyAllowance = await wipToken.allowance(receiverAddress, ROYALTY_POLICY_LAP);
                if (royaltyAllowance < approvalAmount) {
                    loadingText.textContent = 'Approving RoyaltyPolicy...';
                    const approveTx2 = await wipToken.approve(ROYALTY_POLICY_LAP, approvalAmount);
                    console.log('Approve RoyaltyPolicy TX:', approveTx2.hash);
                    await approveTx2.wait();
                }

                // Step 4: Mint license token
                loadingText.textContent = 'Minting license token...';

                // Full LicensingModule ABI with predictMintingLicenseFee for debugging
                const licensingABI = [
                    {
                        "inputs": [
                            {"name": "licensorIpId", "type": "address"},
                            {"name": "licenseTemplate", "type": "address"},
                            {"name": "licenseTermsId", "type": "uint256"},
                            {"name": "amount", "type": "uint256"},
                            {"name": "receiver", "type": "address"},
                            {"name": "royaltyContext", "type": "bytes"},
                            {"name": "maxMintingFee", "type": "uint256"},
                            {"name": "maxRevenueShare", "type": "uint32"}
                        ],
                        "name": "mintLicenseTokens",
                        "outputs": [{"name": "", "type": "uint256"}],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {"name": "licensorIpId", "type": "address"},
                            {"name": "licenseTemplate", "type": "address"},
                            {"name": "licenseTermsId", "type": "uint256"},
                            {"name": "amount", "type": "uint256"},
                            {"name": "receiver", "type": "address"},
                            {"name": "royaltyContext", "type": "bytes"}
                        ],
                        "name": "predictMintingLicenseFee",
                        "outputs": [
                            {"name": "currencyToken", "type": "address"},
                            {"name": "tokenAmount", "type": "uint256"}
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];

                const licensingModule = new ethers.Contract(
                    LICENSING_MODULE,
                    licensingABI,
                    signer
                );

                // First, predict the minting fee to verify the call will work
                console.log('Predicting minting fee...');
                try {
                    const [feeToken, feeAmount] = await licensingModule.predictMintingLicenseFee(
                        IP_ASSET_ID,
                        PIL_TEMPLATE,
                        LICENSE_TERMS_ID,
                        1,
                        receiverAddress,
                        "0x"
                    );
                    console.log('Fee Token:', feeToken);
                    console.log('Fee Amount:', ethers.formatEther(feeAmount), 'WIP');
                } catch (predictError) {
                    console.error('Predict fee failed:', predictError);
                    // Continue anyway - this might fail but the mint might still work
                }

                // Try to estimate gas first to get better error
                console.log('Estimating gas...');
                try {
                    const gasEstimate = await licensingModule.mintLicenseTokens.estimateGas(
                        IP_ASSET_ID,
                        PIL_TEMPLATE,
                        LICENSE_TERMS_ID,
                        1,
                        receiverAddress,
                        "0x",
                        ethers.parseEther("1"),
                        10000
                    );
                    console.log('Gas estimate:', gasEstimate.toString());
                } catch (gasError) {
                    console.error('Gas estimation failed:', gasError);
                    // Extract revert reason if available
                    if (gasError.data) {
                        console.error('Revert data:', gasError.data);
                    }
                    throw gasError;
                }

                // Mint license token (8 parameters)
                const tx = await licensingModule.mintLicenseTokens(
                    IP_ASSET_ID,
                    PIL_TEMPLATE,
                    LICENSE_TERMS_ID,
                    1, // amount
                    receiverAddress,
                    "0x", // royaltyContext (empty for PIL)
                    ethers.parseEther("1"), // maxMintingFee (1 IP max)
                    10000 // maxRevenueShare (100% in basis points)
                );

                console.log('Transaction sent:', tx.hash);
                loadingText.textContent = 'Waiting for confirmation...';

                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('Transaction confirmed:', receipt);

                loadingDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
                document.getElementById('tx-link').href =
                    `https://www.storyscan.io/tx/${tx.hash}`;

            } catch (error) {
                console.error('Purchase error:', error);
                console.error('Error details:', {
                    code: error.code,
                    reason: error.reason,
                    data: error.data,
                    message: error.message,
                    shortMessage: error.shortMessage,
                    info: error.info
                });
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');

                // Try to extract a meaningful error message
                let errorMsg = 'Transaction failed';
                if (error.reason) {
                    errorMsg = error.reason;
                } else if (error.shortMessage) {
                    errorMsg = error.shortMessage;
                } else if (error.message) {
                    errorMsg = error.message;
                }

                // Check for common Story Protocol errors
                if (errorMsg.includes('LicensingModule__LicenseTermsNotFound')) {
                    errorMsg = 'License terms not found - the license may not be attached to this IP';
                } else if (errorMsg.includes('LicensingModule__MintingFeeExceeded')) {
                    errorMsg = 'Minting fee exceeded maximum - try increasing maxMintingFee';
                } else if (errorMsg.includes('ERC20InsufficientAllowance')) {
                    errorMsg = 'Insufficient WIP allowance - approval may have failed';
                } else if (errorMsg.includes('ERC20InsufficientBalance')) {
                    errorMsg = 'Insufficient WIP balance';
                }

                document.getElementById('error-message').textContent = errorMsg;
            }
        }
    </script>
</body>
</html>
