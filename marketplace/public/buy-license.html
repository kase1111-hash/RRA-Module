<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.0.0-mainnet">
    <title>Purchase License - Repository License</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-16 max-w-2xl">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Purchase License</h1>
                <p class="text-gray-400">Powered by Story Protocol</p>
            </div>

            <!-- License Details -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">License Details</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Price</span>
                        <span id="price-display" class="font-mono text-green-400"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Type</span>
                        <span>Perpetual</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Transferable</span>
                        <span>Yes</span>
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Included Features</h2>
                <ul class="space-y-2">
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>AI-Driven Negotiation Agents</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Blockchain License Management</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>GitHub Integration</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Automated Revenue Distribution</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Knowledge Base Generation</li>
                </ul>
            </div>

            <!-- Wallet Connection -->
            <div id="wallet-section" class="mb-6">
                <button
                    id="connect-btn"
                    onclick="connectWallet()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Connect Wallet
                </button>
            </div>

            <!-- Purchase Button (hidden until wallet connected) -->
            <div id="purchase-section" class="hidden">
                <div class="bg-gray-700/50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Connected:</span>
                        <span id="wallet-address" class="font-mono text-sm"></span>
                    </div>
                </div>
                <button
                    id="purchase-btn"
                    onclick="purchaseLicense()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Purchase License for <span id="btn-price-display"></span>
                </button>
            </div>

            <!-- Status Messages -->
            <div id="status" class="mt-6 text-center hidden">
                <div id="status-loading" class="hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                    <p class="text-gray-400">Processing transaction...</p>
                </div>
                <div id="status-success" class="hidden text-green-400">
                    <p class="text-xl mb-2">License Purchased!</p>
                    <a id="tx-link" href="#" target="_blank" class="text-blue-400 hover:underline">View on Explorer</a>
                </div>
                <div id="status-error" class="hidden text-red-400">
                    <div id="error-message"></div>
                </div>
            </div>

            <!-- Debug Output -->
            <div id="debug-output" class="hidden mt-6 bg-gray-900 rounded-xl p-4 text-left font-mono overflow-auto max-h-64 border border-gray-700">
            </div>
        </div>

        <!-- Story Protocol Info -->
        <div class="text-center mt-8 text-gray-500">
            <p>License NFT minted on <a href="https://story.foundation" target="_blank" class="text-blue-400 hover:underline">Story Protocol</a></p>
            <p class="text-sm mt-2">
                <a id="ip-asset-link" href="#" target="_blank" class="hover:underline">
                    View IP Asset on Explorer
                </a>
            </p>
            <p class="text-xs mt-4 text-gray-600">v2.1.0-mainnet | IP: 0xf08574c...a07F | Terms: 28437</p>
        </div>
    </div>

    <script>
        // ============================================
        // USER CONFIGURATION - Match these to your .market.yaml
        // ============================================
        const CONFIG = {
            // Pricing (from .market.yaml target_price)
            price: 0.005,
            currency: "IP",  // Native IP token for payments

            // Network: "mainnet" or "testnet"
            network: "mainnet",

            // Story Protocol IP Asset (your registered IP)
            ipAssetId: "0xf08574c30337dde7C38869b8d399BA07ab23a07F",
            licenseTermsId: 28437
        };

        // ============================================
        // NETWORK CONFIGURATION (auto-configured based on CONFIG.network)
        // ============================================
        const NETWORKS = {
            mainnet: {
                chainId: 1514,
                rpc: "https://mainnet.storyrpc.io",
                explorer: "https://explorer.story.foundation",
                name: "Story Protocol"
            },
            testnet: {
                chainId: 1315,
                rpc: "https://aeneid.storyrpc.io",
                explorer: "https://aeneid.explorer.story.foundation",
                name: "Story Aeneid Testnet"
            }
        };

        // Derived configuration
        const NETWORK = NETWORKS[CONFIG.network];
        const PRICE_WEI = (CONFIG.price * 1e18).toString();

        // Story Protocol Contract Addresses (Mainnet - Chain ID 1514)
        // See: https://docs.story.foundation/developers/deployed-smart-contracts
        const LICENSING_MODULE = "0x04fbd8a2e56dd85CFD5500A4A4DfA955B9f1dE6f";  // Mainnet
        const PIL_TEMPLATE = "0x2E896b0b2Fdb7457499B56AAaA4AE55BCB4Cd316";      // Mainnet

        let provider;
        let signer;

        // Initialize page displays on page load
        function initializeDisplays() {
            // Set price displays
            const priceText = `${CONFIG.price} ${CONFIG.currency}`;
            document.getElementById('price-display').textContent = priceText;
            document.getElementById('btn-price-display').textContent = priceText;

            // Set IP Asset explorer link
            document.getElementById('ip-asset-link').href =
                `${NETWORK.explorer}/address/${CONFIG.ipAssetId}`;
        }

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeDisplays);

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet');
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);

                // Check if on Story Protocol network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== NETWORK.chainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + NETWORK.chainId.toString(16) }],
                        });
                    } catch (switchError) {
                        // Chain not added, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + NETWORK.chainId.toString(16),
                                    chainName: NETWORK.name,
                                    nativeCurrency: { name: CONFIG.currency, symbol: CONFIG.currency, decimals: 18 },
                                    rpcUrls: [NETWORK.rpc],
                                    blockExplorerUrls: [NETWORK.explorer],
                                }],
                            });
                        }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                const address = await signer.getAddress();

                document.getElementById('wallet-address').textContent =
                    address.slice(0, 6) + '...' + address.slice(-4);
                document.getElementById('wallet-section').classList.add('hidden');
                document.getElementById('purchase-section').classList.remove('hidden');
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        // Parse detailed error messages from contract reverts
        function parseContractError(error) {
            const errorInfo = {
                type: 'unknown',
                message: 'Transaction failed',
                details: ''
            };

            // Check for user rejection
            if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
                errorInfo.type = 'rejected';
                errorInfo.message = 'Transaction rejected by user';
                return errorInfo;
            }

            // Check for insufficient funds
            if (error.code === 'INSUFFICIENT_FUNDS' ||
                (error.message && error.message.includes('insufficient funds'))) {
                errorInfo.type = 'insufficient_funds';
                errorInfo.message = 'Insufficient funds for transaction';
                errorInfo.details = `Required: ${CONFIG.price} ${CONFIG.currency} + gas fees`;
                return errorInfo;
            }

            // Parse revert reasons
            const revertReason = error.reason || error.data?.message || '';
            const errorMessage = error.message || '';

            // Known Story Protocol errors
            const knownErrors = {
                'LicensingModule__LicenseTermsNotFound': 'License terms ID not found. The license terms may not be registered.',
                'LicensingModule__IpNotRegistered': 'IP Asset not registered in Story Protocol.',
                'LicensingModule__LicenseNotAttachedToIp': 'License terms not attached to this IP Asset.',
                'LicensingModule__MintingFeeTokenMismatch': 'Payment token mismatch. Check if ETH or a specific token is required.',
                'LicensingModule__InsufficientMintingFee': 'Insufficient minting fee sent.',
                'LicensingModule__ReceiverZeroAddress': 'Receiver address cannot be zero.',
                'PILicenseTemplate__ZeroLicenseTemplate': 'Invalid PIL template address.',
                'require(false)': 'Contract requirement failed. Possible causes:\n• License terms not attached to IP\n• IP not registered\n• Wrong license terms ID\n• Incorrect payment amount'
            };

            for (const [key, msg] of Object.entries(knownErrors)) {
                if (revertReason.includes(key) || errorMessage.includes(key)) {
                    errorInfo.type = 'contract_error';
                    errorInfo.message = msg;
                    errorInfo.details = `Error code: ${key}`;
                    return errorInfo;
                }
            }

            // Generic revert
            if (revertReason) {
                errorInfo.type = 'revert';
                errorInfo.message = revertReason;
            } else if (errorMessage) {
                errorInfo.type = 'error';
                errorInfo.message = errorMessage.substring(0, 200);
            }

            return errorInfo;
        }

        // Log debug information
        function logDebugInfo(label, data) {
            console.log(`[DEBUG] ${label}:`, data);
            const debugDiv = document.getElementById('debug-output');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div class="text-xs"><span class="text-gray-500">[${timestamp}]</span> <span class="text-blue-400">${label}:</span> ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        async function purchaseLicense() {
            if (!signer) {
                alert('Please connect your wallet first');
                return;
            }

            const statusDiv = document.getElementById('status');
            const loadingDiv = document.getElementById('status-loading');
            const successDiv = document.getElementById('status-success');
            const errorDiv = document.getElementById('status-error');
            const debugDiv = document.getElementById('debug-output');

            statusDiv.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            if (debugDiv) {
                debugDiv.classList.remove('hidden');
                debugDiv.innerHTML = '<div class="text-yellow-400 font-bold mb-2">Transaction Debug Log:</div>';
            }

            try {
                // Log configuration
                logDebugInfo('Network', CONFIG.network);
                logDebugInfo('Chain ID', NETWORK.chainId);
                logDebugInfo('LicensingModule', LICENSING_MODULE);
                logDebugInfo('PIL Template', PIL_TEMPLATE);
                logDebugInfo('IP Asset ID', CONFIG.ipAssetId);
                logDebugInfo('License Terms ID', CONFIG.licenseTermsId);
                logDebugInfo('Price (ETH)', CONFIG.price);
                logDebugInfo('Price (Wei)', PRICE_WEI);

                // Verify network
                const network = await provider.getNetwork();
                logDebugInfo('Connected Chain ID', Number(network.chainId));

                if (Number(network.chainId) !== NETWORK.chainId) {
                    throw new Error(`Wrong network! Expected chain ${NETWORK.chainId}, got ${network.chainId}`);
                }

                // ABI for mintLicenseTokens with error definitions
                const licensingABI = [
                    {
                        "inputs": [
                            {"name": "licensorIpId", "type": "address"},
                            {"name": "licenseTemplate", "type": "address"},
                            {"name": "licenseTermsId", "type": "uint256"},
                            {"name": "amount", "type": "uint256"},
                            {"name": "receiver", "type": "address"},
                            {"name": "royaltyContext", "type": "bytes"}
                        ],
                        "name": "mintLicenseTokens",
                        "outputs": [{"name": "", "type": "uint256[]"}],
                        "stateMutability": "payable",
                        "type": "function"
                    }
                ];

                const licensingModule = new ethers.Contract(
                    LICENSING_MODULE,
                    licensingABI,
                    signer
                );

                const receiverAddress = await signer.getAddress();
                logDebugInfo('Receiver Address', receiverAddress);

                // Check wallet balance
                const balance = await provider.getBalance(receiverAddress);
                const balanceEth = ethers.formatEther(balance);
                logDebugInfo('Wallet Balance', `${balanceEth} ${CONFIG.currency}`);

                if (balance < BigInt(PRICE_WEI)) {
                    throw new Error(`Insufficient balance. Have: ${balanceEth} ${CONFIG.currency}, Need: ${CONFIG.price} ${CONFIG.currency}`);
                }

                // Estimate gas first to catch errors before sending
                logDebugInfo('Status', 'Estimating gas...');
                let gasEstimate;
                try {
                    gasEstimate = await licensingModule.mintLicenseTokens.estimateGas(
                        CONFIG.ipAssetId,
                        PIL_TEMPLATE,
                        CONFIG.licenseTermsId,
                        1,
                        receiverAddress,
                        "0x",
                        { value: PRICE_WEI }
                    );
                    logDebugInfo('Gas Estimate', gasEstimate.toString());
                } catch (estimateError) {
                    logDebugInfo('Gas Estimation Failed', estimateError.message || estimateError);

                    // Try to get more details via static call
                    logDebugInfo('Status', 'Attempting static call for detailed error...');
                    try {
                        await licensingModule.mintLicenseTokens.staticCall(
                            CONFIG.ipAssetId,
                            PIL_TEMPLATE,
                            CONFIG.licenseTermsId,
                            1,
                            receiverAddress,
                            "0x",
                            { value: PRICE_WEI }
                        );
                    } catch (staticError) {
                        logDebugInfo('Static Call Error', staticError.reason || staticError.message);
                        throw staticError;
                    }
                    throw estimateError;
                }

                // Send transaction
                logDebugInfo('Status', 'Sending transaction...');
                const tx = await licensingModule.mintLicenseTokens(
                    CONFIG.ipAssetId,
                    PIL_TEMPLATE,
                    CONFIG.licenseTermsId,
                    1,
                    receiverAddress,
                    "0x",
                    { value: PRICE_WEI, gasLimit: gasEstimate * 120n / 100n } // 20% buffer
                );

                logDebugInfo('Transaction Hash', tx.hash);
                logDebugInfo('Status', 'Waiting for confirmation...');

                // Wait for confirmation
                const receipt = await tx.wait();
                logDebugInfo('Block Number', receipt.blockNumber);
                logDebugInfo('Gas Used', receipt.gasUsed.toString());
                logDebugInfo('Status', 'SUCCESS!');

                loadingDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
                document.getElementById('tx-link').href =
                    `${NETWORK.explorer}/tx/${tx.hash}`;

            } catch (error) {
                console.error('Purchase error:', error);
                logDebugInfo('ERROR', error.message || error);

                const parsedError = parseContractError(error);
                logDebugInfo('Parsed Error Type', parsedError.type);
                logDebugInfo('Parsed Error Message', parsedError.message);

                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');

                let errorHtml = `<p class="font-bold">${parsedError.message}</p>`;
                if (parsedError.details) {
                    errorHtml += `<p class="text-sm mt-2 text-gray-400">${parsedError.details}</p>`;
                }
                errorHtml += `<p class="text-xs mt-2 text-gray-500">Check browser console (F12) for full details</p>`;

                document.getElementById('error-message').innerHTML = errorHtml;
            }
        }
    </script>
</body>
</html>
