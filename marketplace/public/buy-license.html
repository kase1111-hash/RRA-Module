<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase License - RRA-Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-16 max-w-2xl">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Purchase License</h1>
                <p class="text-gray-400">Powered by Story Protocol</p>
            </div>

            <!-- License Details -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">License Details</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Price</span>
                        <span class="font-mono text-green-400">0.005 ETH</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Type</span>
                        <span>Perpetual</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Transferable</span>
                        <span>Yes</span>
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Included Features</h2>
                <ul class="space-y-2">
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Automated License Minting</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>On-Chain Revenue Distribution</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Story Protocol Integration</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>Smart Contract Infrastructure</li>
                    <li class="flex items-center gap-2"><span class="text-green-500">&#10003;</span>DeFi Features (Yield, Lending, Fractional IP)</li>
                </ul>
            </div>

            <!-- Wallet Connection -->
            <div id="wallet-section" class="mb-6">
                <button
                    id="connect-btn"
                    onclick="connectWallet()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Connect Wallet
                </button>
            </div>

            <!-- Purchase Button (hidden until wallet connected) -->
            <div id="purchase-section" class="hidden">
                <div class="bg-gray-700/50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Connected:</span>
                        <span id="wallet-address" class="font-mono text-sm"></span>
                    </div>
                </div>
                <button
                    id="purchase-btn"
                    onclick="purchaseLicense()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                >
                    Purchase License for 0.005 ETH
                </button>
            </div>

            <!-- Status Messages -->
            <div id="status" class="mt-6 text-center hidden">
                <div id="status-loading" class="hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                    <p class="text-gray-400">Processing transaction...</p>
                </div>
                <div id="status-success" class="hidden text-green-400">
                    <p class="text-xl mb-2">License Purchased!</p>
                    <a id="tx-link" href="#" target="_blank" class="text-blue-400 hover:underline">View on Explorer</a>
                </div>
                <div id="status-error" class="hidden text-red-400">
                    <p id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Story Protocol Info -->
        <div class="text-center mt-8 text-gray-500">
            <p>License NFT minted on <a href="https://story.foundation" target="_blank" class="text-blue-400 hover:underline">Story Protocol</a></p>
            <p class="text-sm mt-2">
                <a href="https://explorer.story.foundation/ipa/0xf08574c30337dde7C38869b8d399BA07ab23a07F" target="_blank" class="hover:underline">
                    View IP Asset on StoryScan
                </a>
            </p>
        </div>
    </div>

    <script>
        // All lowercase addresses bypass checksum validation in ethers.js
        const IP_ASSET_ID = "0xf08574c30337dde7c38869b8d399ba07ab23a07f";
        const LICENSE_TERMS_ID = 28437;
        const PRICE_WEI = "5000000000000000"; // 0.005 ETH for testing
        const STORY_CHAIN_ID = 1514;
        const STORY_RPC = "https://mainnet.storyrpc.io";

        // Story Protocol Licensing Module Address (lowercase to bypass checksum)
        const LICENSING_MODULE = "0x04fbd8a2e56dd85cfd5500a4a4dfa955b9f1de6f";
        const PIL_TEMPLATE = "0x2e896b0b2fdb7457499b56aaaa4ae55bcb4cd316";

        let provider;
        let signer;

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet');
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);

                // Check if on Story Protocol network
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== STORY_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + STORY_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        // Chain not added, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + STORY_CHAIN_ID.toString(16),
                                    chainName: 'Story Protocol',
                                    nativeCurrency: { name: 'IP', symbol: 'IP', decimals: 18 },
                                    rpcUrls: [STORY_RPC],
                                    blockExplorerUrls: ['https://storyscan.io'],
                                }],
                            });
                        }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                const address = await signer.getAddress();

                document.getElementById('wallet-address').textContent =
                    address.slice(0, 6) + '...' + address.slice(-4);
                document.getElementById('wallet-section').classList.add('hidden');
                document.getElementById('purchase-section').classList.remove('hidden');
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function purchaseLicense() {
            if (!signer) {
                alert('Please connect your wallet first');
                return;
            }

            const statusDiv = document.getElementById('status');
            const loadingDiv = document.getElementById('status-loading');
            const successDiv = document.getElementById('status-success');
            const errorDiv = document.getElementById('status-error');

            statusDiv.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                // ABI for mintLicenseTokens
                const licensingABI = [
                    {
                        "inputs": [
                            {"name": "licensorIpId", "type": "address"},
                            {"name": "licenseTemplate", "type": "address"},
                            {"name": "licenseTermsId", "type": "uint256"},
                            {"name": "amount", "type": "uint256"},
                            {"name": "receiver", "type": "address"},
                            {"name": "royaltyContext", "type": "bytes"}
                        ],
                        "name": "mintLicenseTokens",
                        "outputs": [{"name": "", "type": "uint256[]"}],
                        "stateMutability": "payable",
                        "type": "function"
                    }
                ];

                const licensingModule = new ethers.Contract(
                    LICENSING_MODULE,
                    licensingABI,
                    signer
                );

                const receiverAddress = await signer.getAddress();

                // Mint license token
                const tx = await licensingModule.mintLicenseTokens(
                    IP_ASSET_ID,
                    PIL_TEMPLATE,
                    LICENSE_TERMS_ID,
                    1, // amount
                    receiverAddress,
                    "0x", // royaltyContext
                    { value: PRICE_WEI }
                );

                console.log('Transaction sent:', tx.hash);

                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('Transaction confirmed:', receipt);

                loadingDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
                document.getElementById('tx-link').href =
                    `https://storyscan.io/tx/${tx.hash}`;

            } catch (error) {
                console.error('Purchase error:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('error-message').textContent =
                    error.reason || error.message || 'Transaction failed';
            }
        }
    </script>
</body>
</html>
